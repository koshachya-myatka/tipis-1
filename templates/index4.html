<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эффективность ПО хранилища данных</title>
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>
<h1>Эффективность программного обеспечения хранилища данных</h1>
<div id="messages"></div>

<div class="tables-container">
    <!-- Таблица параметров X1-X14 -->
    <div class="table-wrapper">
        <h3 class="table-title">Параметры модели</h3>
        <div class="scrollable-table">
            <table>
                <thead>
                <tr>
                    <th>Параметр</th>
                    <th>Название</th>
                    <th>Начальное (%)</th>
                    <th>Макс. (%)</th>
                </tr>
                </thead>
                <tbody>
                {% for i in range(1, 15) %}
                {% set param_name = 'X' ~ i %}
                <tr>
                    <td>X<sub>{{ i }}</sub></td>
                    <td>
                        {% if param_name == 'X1' %}Эффективность функционирования хранилища данных
                        {% elif param_name == 'X2' %}Качество программного обеспечения (ПО)
                        {% elif param_name == 'X3' %}Корректность ПО
                        {% elif param_name == 'X4' %}Надежность программного обеспечения
                        {% elif param_name == 'X5' %}Доступность программного обеспечения
                        {% elif param_name == 'X6' %}Возможность интенсивного использования ПО
                        {% elif param_name == 'X7' %}Прослеживаемость ПО
                        {% elif param_name == 'X8' %}Функциональная полнота ПО
                        {% elif param_name == 'X9' %}Обеспечение требуемой последовательности работ при проектировании хранилища
                        {% elif param_name == 'X10' %}Практичность ПО
                        {% elif param_name == 'X11' %}Устойчивость к ошибкам данных программного обеспечения
                        {% elif param_name == 'X12' %}Эффективность выполнения транзакций
                        {% elif param_name == 'X13' %}Степень мотивации персонала
                        {% elif param_name == 'X14' %}Удобство тестирования ПО
                        {% endif %}
                    </td>
                    <td>
                        <input type="number"
                               min="0" max="100"
                               id="X{{ i }}"
                               value="{{ parameters.get('X' ~ i, '') }}"
                               step="0.01">
                    </td>
                    <td>
                        <input type="number"
                               min="0" max="100"
                               id="X{{ i }}_max"
                               value="{{ parameters.get('X' ~ i ~ '_max', '') }}"
                               step="0.01">
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Таблица возмущений -->
    <div class="table-wrapper">
        <h3 class="table-title">Возмущения</h3>
        <div class="scrollable-table">
            <table>
                <thead>
                <tr>
                    <th>Возмущение</th>
                    <th>Название</th>
                    <th colspan="4">Коэффициенты</th>
                </tr>
                </thead>
                <tbody>
                {% set zeta_names = [
                'Увеличение количества источников новых данных',
                'Частота изменения периодов сдачи финансовой отчетности предприятия',
                'Сокращение квалифицированной поддержки вендора',
                'Рост интенсивности перехода на Open Source решения',
                'Увеличение количества новых стандартов при реализации Open Source решений'
                ] %}

                {% for i in range(1, 6) %}
                <tr>
                    <td>ζ<sub>{{ i }}</sub></td>
                    <td>{{ zeta_names[i-1] }}</td>
                    <td class="formula-row">
                        <input type="number" step="0.001" class="formula-input" id="zeta{{ i }}_a3"
                               value="{{ parameters.get('zeta' ~ i ~ '_a3', '') }}"> * t³ +
                        <input type="number" step="0.001" class="formula-input" id="zeta{{ i }}_a2"
                               value="{{ parameters.get('zeta' ~ i ~ '_a2', '') }}"> * t² +
                        <input type="number" step="0.001" class="formula-input" id="zeta{{ i }}_a1"
                               value="{{ parameters.get('zeta' ~ i ~ '_a1', '') }}"> * t +
                        <input type="number" step="0.001" class="formula-input" id="zeta{{ i }}_a0"
                               value="{{ parameters.get('zeta' ~ i ~ '_a0', '') }}">
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="table-wrapper">
        <h3 class="table-title">Внутренние функции</h3>
        <div class="scrollable-table">
            <table>
                <thead>
                <tr>
                    <th>Функция</th>
                    <th>Формула</th>
                </tr>
                </thead>
                <tbody>
                {% set f_to_x = {
                1: (1, True),
                16: (2, True),
                67: (6, True),
                104: (10, True),
                2: (2, False), 3: (3, False), 4: (4, False), 5: (5, False),
                6: (6, False), 7: (7, False), 8: (8, False), 9: (9, False),
                10: (10, False), 11: (11, False), 12: (12, False), 13: (13, False), 14: (14, False),
                15: (1, False), 17: (3, False), 18: (4, False), 19: (5, False), 20: (6, False),
                21: (7, False), 22: (8, False), 23: (9, False), 24: (10, False), 25: (11, False),
                26: (12, False), 27: (13, False), 28: (14, False),
                29: (1, False), 30: (2, False), 31: (3, False), 32: (4, False), 33: (5, False),
                34: (6, False), 35: (7, False), 36: (8, False), 37: (9, False), 38: (10, False),
                39: (11, False), 40: (12, False), 41: (13, False), 42: (14, False),
                43: (1, False), 44: (2, False), 45: (3, False), 46: (4, False),
                47: (5, False), 48: (6, False),
                49: (7, False), 50: (8, False), 51: (9, False), 52: (10, False),
                53: (11, False), 54: (12, False), 55: (13, False),
                56: (1, False),
                57: (4, False), 58: (6, False), 59: (9, False), 60: (10, False), 61: (13, False),
                62: (1, False), 63: (2, False), 64: (3, False), 65: (4, False), 66: (5, False),
                68: (7, False), 69: (8, False), 70: (9, False), 71: (10, False), 72: (11, False),
                73: (12, False), 74: (13, False), 75: (14, False),
                76: (2, False), 77: (4, False), 78: (14, False),
                79: (4, False), 80: (6, False), 81: (9, False), 82: (10, False),
                83: (1, False), 84: (2, False), 85: (3, False), 86: (4, False), 87: (5, False),
                88: (6, False), 89: (7, False), 90: (10, False), 91: (11, False), 92: (12, False),
                93: (13, False), 94: (14, False),
                95: (1, False), 96: (2, False), 97: (3, False), 98: (4, False), 99: (5, False),
                100: (6, False), 101: (7, False), 102: (8, False), 103: (9, False),
                105: (11, False), 106: (12, False), 107: (13, False), 108: (14, False),
                109: (1, False), 110: (2, False), 111: (3, False), 112: (4, False),
                113: (8, False), 114: (10, False), 115: (12, False), 116: (13, False), 117: (14, False),
                118: (5, False), 119: (6, False),
                120: (1, False), 121: (2, False), 122: (3, False), 123: (4, False),
                124: (5, False), 125: (6, False), 126: (7, False), 127: (8, False),
                128: (9, False), 129: (10, False), 130: (11, False), 131: (13, False), 132: (14, False),
                133: (1, False), 134: (2, False), 135: (3, False), 136: (4, False),
                137: (5, False), 138: (6, False), 139: (7, False), 140: (8, False),
                141: (10, False), 142: (11, False), 143: (12, False), 144: (13, False), 145: (14, False),
                146: (9, False),
                147: (5, False), 148: (7, False), 149: (11, False), 150: (13, False),
                } %}

                {% for i in range(1, 151) %}
                {% set x_index = f_to_x.get(i, (1, False))[0] %}
                {% set is_constant = f_to_x.get(i, (1, False))[1] %}

                <tr>
                    <td>
                        f<sub>{{ i }}</sub>(X<sub>{{ x_index }}</sub>)
                    </td>
                    <td class="formula-row">
                        {% if is_constant %}
                        f<sub>{{ i }}</sub> = 1 (константа)
                        {% else %}
                        f<sub>{{ i }}</sub> =
                        <input type="number" step="0.001" class="formula-input-small"
                               id="f{{ i }}_a3" value="{{ parameters.get('f' ~ i ~ '_a3', '0.0') }}"> *
                        X<sub>{{ x_index }}</sub>³ +

                        <input type="number" step="0.001" class="formula-input-small"
                               id="f{{ i }}_a2" value="{{ parameters.get('f' ~ i ~ '_a2', '0.0') }}"> *
                        X<sub>{{ x_index }}</sub>² +

                        <input type="number" step="0.001" class="formula-input-small"
                               id="f{{ i }}_a1" value="{{ parameters.get('f' ~ i ~ '_a1', '0.5') }}"> *
                        X<sub>{{ x_index }}</sub> +

                        <input type="number" step="0.001" class="formula-input-small"
                               id="f{{ i }}_a0" value="{{ parameters.get('f' ~ i ~ '_a0', '0.2') }}">
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="buttons-container">
    <a href="{{ url_for('main') }}" class="home-button">На главную</a>
    <button id="clearBtn">Очистить значения</button>
    <button id="randomBtn">Случайные значения</button>
    <button id="plotBtn">Построить диаграммы</button>
</div>

<div id="diagramsContainer" class="diagrams-container" style="display: none;">
    <h2>Результаты моделирования</h2>
    <div class="diagram">
        <h3>Динамика показателей эффективности</h3>
        <img id="timeSeriesImg" src="" alt="График изменения параметров по времени">
    </div>
    <div class="diagram">
        <h3>Лепестковые диаграммы показателей</h3>
        <img id="radarChartsImg" src="" alt="Лепестковые диаграммы">
    </div>
</div>

<script>
    // Функция для отображения сообщений
    function showMessage(message, type, duration = 5000) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        messageDiv.textContent = message;
        messagesDiv.appendChild(messageDiv);
        messageDiv.style.opacity = 0;
        setTimeout(() => (messageDiv.style.opacity = 1), 50);
        setTimeout(() => {
            messageDiv.style.opacity = 0;
            setTimeout(() => messageDiv.remove(), 500);
        }, duration);
    }

    // Функция для получения всех значений из формы
    function getFormData() {
        const inputs = document.querySelectorAll('input');
        const data = {};
        inputs.forEach(input => {
            data[input.id] = input.value;
        });
        return data;
    }

    // Функция для проверки значений параметров
    function validateParameterValues() {
        let isValid = true;
        let invalidParams = [];

        for (let i = 1; i <= 14; i++) {
            const initialInput = document.getElementById(`X${i}`);
            const maxInput = document.getElementById(`X${i}_max`);

            if (!initialInput || !maxInput) continue;

            const initValue = parseFloat(initialInput.value);
            const maxValue = parseFloat(maxInput.value);

            // Сбрасываем цвет перед проверкой
            initialInput.style.borderColor = '';
            maxInput.style.borderColor = '';

            if (isNaN(initValue) || isNaN(maxValue)) continue;

            let hasError = false;

            // Проверяем: initial ≤ max
            if (maxValue < initValue) {
                maxInput.style.borderColor = '#e74c3c';
                initialInput.style.borderColor = '#e74c3c';
                hasError = true;
            }

            // Проверяем диапазон 0-100%
            if (initValue < 0 || initValue > 100 || maxValue < 0 || maxValue > 100) {
                initialInput.style.borderColor = '#e74c3c';
                maxInput.style.borderColor = '#e74c3c';
                hasError = true;
            }

            if (hasError) {
                isValid = false;
                invalidParams.push(`X${i}`);
            }
        }

        if (!isValid) {
            const list = invalidParams.join(', ');
            showMessage(
                `Ошибка: проверьте значения параметров ${list} (0-100%, начальное ≤ max)`,
                'error'
            );
        }

        return isValid;
    }

    // Проверка одного параметра при вводе
    function validateSingleParameter(index) {
        const initialInput = document.getElementById(`X${index}`);
        const maxInput = document.getElementById(`X${index}_max`);

        if (!initialInput || !maxInput) return;

        const initValue = parseFloat(initialInput.value);
        const maxValue = parseFloat(maxInput.value);

        // Сбрасываем цвета перед проверкой
        [initialInput, maxInput].forEach(input => {
            input.style.borderColor = '';
        });

        // Проверяем, если оба значения заданы
        if (!isNaN(initValue) && !isNaN(maxValue)) {
            if (maxValue < initValue) {
                maxInput.style.borderColor = '#e74c3c';
                initialInput.style.borderColor = '#e74c3c';
            }
            if (initValue < 0 || initValue > 100 || maxValue < 0 || maxValue > 100) {
                initialInput.style.borderColor = '#e74c3c';
                maxInput.style.borderColor = '#e74c3c';
            }
        }
    }

    // Добавляем обработчики событий для проверки при вводе
    for (let i = 1; i <= 14; i++) {
        const initialInput = document.getElementById(`X${i}`);
        const maxInput = document.getElementById(`X${i}_max`);

        [initialInput, maxInput].forEach(input => {
            if (!input) return;
            input.addEventListener('input', () => validateSingleParameter(i));
            input.addEventListener('blur', () => validateSingleParameter(i));
        });
    }

    // Очистка всех значений
    document.getElementById('clearBtn').addEventListener('click', function () {
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.value = '';
            input.style.borderColor = '';
        });
        document.getElementById('diagramsContainer').style.display = 'none';

        fetch('/clear4', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('Все значения очищены', 'success');
                }
            })
            .catch(error => {
                showMessage('Ошибка при очистке значений', 'error');
            });
    });

    // Случайные значения
    document.getElementById('randomBtn').addEventListener('click', function () {
        fetch('/random4', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    for (const [key, value] of Object.entries(data.parameters)) {
                        const input = document.getElementById(key);
                        if (input) {
                            input.value = value;
                            input.style.borderColor = '';
                        }
                    }
                    showMessage('Значения заполнены случайными данными', 'success');
                }
            })
            .catch(error => {
                showMessage('Ошибка при генерации случайных значений', 'error');
            });
    });

    // Построение диаграмм
    document.getElementById('plotBtn').addEventListener('click', function () {
        if (!validateParameterValues()) return;

        const formData = getFormData();

        fetch('/plot4', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('timeSeriesImg').src = 'data:image/png;base64,' + data.time_series;
                    document.getElementById('radarChartsImg').src = 'data:image/png;base64,' + data.radar_charts;
                    document.getElementById('diagramsContainer').style.display = 'block';
                    showMessage('Диаграммы успешно построены', 'success');
                } else {
                    showMessage(data.message || 'Неизвестная ошибка', 'error');
                }
            })
            .catch((error) => {
                console.error('Ошибка при построении диаграмм:', error);
                showMessage('Ошибка при построении диаграмм: ' + error.message, 'error');
            });
    });
</script>
</body>
</html>